<body>
  <h1>反応時間テスト</h1>
  <!-- 音の選択 -->
  <label for="soundSelect">使用する音を選んでください：</label>
  <select id="soundSelect">
    <option value="beep1.mp3">音1</option>
    <option value="beep2.mp3">音2</option>
    <option value="beep3.mp3">音3</option>
    <option value="beep4.mp3">音4</option>
    <option value="beep5.mp3">音5</option>
  </select>
  <button id="previewBtn">試聴</button> <!-- 試聴ボタン -->

  <br><br>

  <button id="startBtn">スタート</button>
  <button id="reactBtn">見えたら/音が鳴ったら押す！</button>
  <p id="signalText"></p>
  <p id="result"></p>
  <p id="errorMsg" style="color: red;"></p>

  <!-- ログはそのまま -->

  <script>
    const startBtn = document.getElementById("startBtn");
    const reactBtn = document.getElementById("reactBtn");
    const previewBtn = document.getElementById("previewBtn");
    const soundSelect = document.getElementById("soundSelect");

    let startTime = 0;
    let actionType = "";
    let ready = false;
    let locked = false;

    const visualLog = [], audioLog = [];

    // 選択された音ファイルを再生
    function playSelectedSound() {
      const audio = new Audio(soundSelect.value);
      audio.play();
    }

    previewBtn.onclick = () => {
      playSelectedSound();
    };

    function updateLog(log, newTime, logEl, avgEl, countEl) {
      if (log.length >= 10) log.shift();
      log.push(newTime);
      logEl.innerHTML = log.map(t => `<li>${t.toFixed(3)} 秒</li>`).join("");
      const avg = log.reduce((a, b) => a + b, 0) / log.length;
      avgEl.textContent = `平均: ${avg.toFixed(3)} 秒`;
      countEl.textContent = `${log.length} / 10 件記録済み`;
    }

    startBtn.onclick = () => {
      result.textContent = "";
      signalText.textContent = "";
      errorMsg.textContent = "";
      ready = false;
      locked = false;

      const delay = Math.random() * 7000 + 3000;
      actionType = Math.random() < 0.5 ? "sound" : "text";

      setTimeout(() => {
        if (!locked) {
          startTime = Date.now();
          ready = true;

          if (actionType === "sound") {
            playSelectedSound();  // 選択した音を再生
          } else {
            signalText.textContent = "今だ！";
          }
        }
      }, delay);
    };

    reactBtn.onclick = () => {
      if (locked) return;

      errorMsg.textContent = "";
      if (!ready) {
        errorMsg.textContent = "まだですよ！再スタートしてください。";
        result.textContent = "";
        locked = true;
        return;
      }

      const reactionTime = (Date.now() - startTime) / 1000;
      result.textContent = `反応時間: ${reactionTime.toFixed(3)} 秒 → ${reactionTime >= 0.3 ? "0.3秒以上" : "0.3秒未満"}`;
      ready = false;
      signalText.textContent = "";

      if (actionType === "text") {
        updateLog(visualLog, reactionTime, visualLogEl, visualAvgEl, visualCountEl);
      } else {
        updateLog(audioLog, reactionTime, audioLogEl, audioAvgEl, audioCountEl);
      }
    };
  </script>
</body>
